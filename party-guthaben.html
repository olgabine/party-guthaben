<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Party Guthaben</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; }
button { padding:14px 22px; margin:6px; font-size:16px; }
#qr-reader { width:320px; margin-top:15px; }
#gast { margin-top:20px; display:none; }
#produkte { margin-top:15px; }
#status { font-weight:bold; margin-top:10px; }
</style>
</head>

<body>

<h2>Party Guthaben</h2>

<button id="scanBtn" onclick="startScan()">QR-Code scannen</button>
<div id="qr-reader"></div>

<div id="status"></div>

<div id="gast">
  <h3 id="name"></h3>
  <p><b>Guthaben:</b> <span id="guthaben"></span> â‚¬</p>

  <button onclick="aufladen()">Aufladen</button>
  <button onclick="auszahlen()">Auszahlen</button>

  <div id="produkte"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const APP_PIN = "739284";

/* PIN-Abfrage */
const pin = prompt("6-stellige PIN eingeben:");
if(pin !== APP_PIN){
  document.body.innerHTML="<h2>Zugriff verweigert</h2>";
  throw new Error("Falscher PIN");
}

/* CONFIG */
const sheetUrl = 'https://script.google.com/macros/s/AKfycbxyfH6JI8RO10ZNmdjl2MPJ5nL6323UvJcpsuXl6LUbPM7UvLB6oYYdRhrUzbEevinlSA/exec';
let currentId = '';
let guthaben = 0;
let scanner = null;
let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

/* STATUS */
function updateStatus(){
  document.getElementById('status').textContent =
    navigator.onLine ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline â€“ Buchungen gespeichert';
}
window.addEventListener('online', syncOffline);
window.addEventListener('offline', updateStatus);
updateStatus();

/* QR SCAN */
function startScan(){
  if(scanner) return;
  scanner = new Html5Qrcode("qr-reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    text=>{
      currentId = text.trim();
      scanner.stop().then(()=>scanner.clear());
      loadGast();
    }
  );
}

/* GAST LADEN */
function loadGast(){
  document.getElementById('gast').style.display='block';
  document.getElementById('name').textContent=currentId;

  if(!navigator.onLine){
    document.getElementById('guthaben').textContent=guthaben.toFixed(2);
    return;
  }

  fetch(`${sheetUrl}?action=check&id=${currentId}`)
    .then(r=>r.json())
    .then(d=>{
      guthaben = d.aktuellesGuthaben || 0;
      document.getElementById('guthaben').textContent=guthaben.toFixed(2);
      renderProdukte(d.produkte);
    });
}

/* PRODUKTE RENDERN */
function renderProdukte(list){
  const div=document.getElementById('produkte');
  div.innerHTML='<h4>Produkte</h4>';
  list.forEach(p=>{
    const b=document.createElement('button');
    b.textContent=`${p.name} â€“ ${p.preis.toFixed(2)} â‚¬`;
    b.onclick=()=>aktion('buchen', p.preis, p.name);
    div.appendChild(b);
  });
}

/* AKTIONEN */
function aktion(type, wert=0, produkt=''){
  if(!navigator.onLine){
    offlineQueue.push({type, wert, produkt, id:currentId});
    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    guthaben -= wert;
    document.getElementById('guthaben').textContent=guthaben.toFixed(2);
    return;
  }

  fetch(`${sheetUrl}?action=${type}&id=${currentId}&wert=${wert}&produkt=${encodeURIComponent(produkt)}`)
    .then(()=>loadGast());
}

function aufladen(){
  let v=parseFloat(prompt("Betrag aufladen (â‚¬):","10"));
  if(v) aktion('aufladen', v);
}

function auszahlen(){
  if(confirm("Restguthaben auszahlen?")){
    aktion('auszahlen');
    guthaben = 0;
    document.getElementById('guthaben').textContent='0.00';
  }
}

/* OFFLINE SYNC */
function syncOffline(){
  updateStatus();
  while(offlineQueue.length){
    const a=offlineQueue.shift();
    fetch(`${sheetUrl}?action=${a.type}&id=${a.id}&wert=${a.wert}&produkt=${encodeURIComponent(a.produkt)}`);
  }
  localStorage.removeItem('offlineQueue');
}
</script>
</body>
</html>
