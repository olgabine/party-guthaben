<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Party Guthaben Party</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #fff;
}

h2, h3 {
  text-shadow: 1px 1px 2px #000;
}

button {
  padding: 16px 24px;
  margin: 6px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.button-green { background-color: #2ecc71; color: #000; }
.button-red   { background-color: #e74c3c; color: #000; }
.button-orange{ background-color: #f39c12; color: #000; }

#qr-reader { width: 320px; margin-top: 15px; }
#status { margin-top: 10px; font-weight: bold; }

#gast { display: none; margin-top: 20px; }

textarea {
  width: 100%;
  height: 70px;
  font-size: 16px;
  resize: none;
  margin-top: 10px;
}

#notiz-counter {
  font-size: 14px;
  margin-top: 4px;
}
</style>
</head>

<body>

<h2>üî• NEUE VERSION L√ÑUFT üî•</h2>

<button class="button-green" onclick="startScan()">üì∑ QR-Code scannen</button>
<div id="qr-reader"></div>

<div id="status"></div>

<div id="gast">
  <h3 id="name">Gast</h3>
  <p><b>Guthaben:</b> <span id="guthaben">0.00</span> ‚Ç¨</p>

  <button class="button-green" onclick="aufladen()">‚û°Ô∏è Aufladen</button>
  <button class="button-red" onclick="auszahlen()">‚¨ÖÔ∏è Auszahlen</button>

  <div id="produkte"></div>

  <p><b>Zwischensumme:</b> <span id="summe">0.00</span> ‚Ç¨</p>
  <button class="button-orange" onclick="buchen()">Buchen ‚úÖ</button>

  <textarea id="notiz" placeholder="Notizen (max. 500 Zeichen)" maxlength="500"></textarea>
  <div id="notiz-counter">500 Zeichen √ºbrig</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== PIN ===== */
const APP_PIN = "739284";
const pin = prompt("6-stellige PIN eingeben:");
if (pin !== APP_PIN) {
  document.body.innerHTML = "<h2>Zugriff verweigert</h2>";
  throw new Error("Falscher PIN");
}

/* ===== STATE ===== */
let currentId = "";
let guthaben = 20;
let summe = 0;
let scanner = null;

/* ===== PRODUKTE ===== */
const produkte = [
  {name:"Bier", preise:[1,1.5,2,2.5,3,3.5]},
  {name:"Wasser", preise:[1,2,3]},
  {name:"Cocktail", preise:[4.5,5.5,6.5,7.5]},
  {name:"Shots", preise:[1,1.5,2,2.5]}
];

/* ===== STATUS ===== */
function updateStatus(){
  document.getElementById("status").textContent =
    navigator.onLine ? "üü¢ Online" : "üî¥ Offline ‚Äì Buchungen werden gemerkt";
}
updateStatus();
window.addEventListener("online", updateStatus);
window.addEventListener("offline", updateStatus);

/* ===== QR SCAN ===== */
function startScan(){
  if (scanner) return;

  scanner = new Html5Qrcode("qr-reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    text => {
      scanner.stop().then(() => scanner.clear());
      currentId = text.trim();
      document.getElementById("name").textContent = currentId;
      document.getElementById("gast").style.display = "block";
      document.getElementById("guthaben").textContent = guthaben.toFixed(2);
      renderProdukte();
    }
  );
}

/* ===== PRODUKTBUTTONS ===== */
function renderProdukte(){
  const div = document.getElementById("produkte");
  div.innerHTML = "<h4>Produkte</h4>";

  produkte.forEach(p => {
    p.preise.forEach(preis => {
      const b = document.createElement("button");
      b.className = "button-orange";
      b.textContent = `${p.name} ‚Äì ${preis.toFixed(2)} ‚Ç¨`;
      b.onclick = () => {
        summe += preis;
        document.getElementById("summe").textContent = summe.toFixed(2);
      };
      div.appendChild(b);
    });
  });
}

/* ===== AKTIONEN ===== */
function aufladen(){
  const v = parseFloat(prompt("Aufladen (‚Ç¨):", "10"));
  if (v) {
    guthaben += v;
    document.getElementById("guthaben").textContent = guthaben.toFixed(2);
  }
}

function auszahlen(){
  if (confirm("Guthaben auszahlen und auf 0 setzen?")) {
    guthaben = 0;
    document.getElementById("guthaben").textContent = "0.00";
  }
}

function buchen(){
  if (summe > guthaben) {
    alert("Nicht genug Guthaben!");
    return;
  }
  guthaben -= summe;
  summe = 0;
  document.getElementById("guthaben").textContent = guthaben.toFixed(2);
  document.getElementById("summe").textContent = "0.00";
  document.getElementById("notiz").value = "";
  document.getElementById("notiz-counter").textContent = "500 Zeichen √ºbrig";
  alert("Gebucht!");
}

/* ===== NOTIZ ===== */
const notiz = document.getElementById("notiz");
const counter = document.getElementById("notiz-counter");

notiz.addEventListener("input", () => {
  const len = notiz.value.length;
  counter.textContent = (500 - len) + " Zeichen √ºbrig";

  if (len <= 200) {
    notiz.style.fontSize = "16px";
  } else {
    let size = 16 - (len - 200) / 20;
    if (size < 8) size = 8;
    notiz.style.fontSize = size + "px";
  }
});
</script>

</body>
</html>
