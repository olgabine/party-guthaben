<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Party Guthaben Party</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #fff;
}

h2, h3, h4 {
  text-shadow: 1px 1px 2px #000;
}

button {
  padding: 14px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  margin: 4px 0;
}

.button-green { background-color: #2ecc71; color: #000; }
.button-red   { background-color: #e74c3c; color: #000; }
.button-orange{ background-color: #f39c12; color: #000; }

.scrollbox {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
  border: 1px solid #444;
  padding: 6px;
  border-radius: 6px;
}

#qr-reader { width: 100%; max-width: 320px; margin-top: 15px; }
#status { margin-top: 10px; font-weight: bold; }

#gast, #produkte, #warenkorb-container { display: none; margin-top: 20px; }

textarea {
  width: 100%;
  height: 70px;
  font-size: 16px;
  resize: none;
  margin-top: 10px;
}

#notiz-counter { font-size: 14px; margin-top: 4px; }

#warenkorb li button {
  padding: 2px 6px;
  font-size: 14px;
  margin-left: 4px;
}
</style>
</head>

<body>

<h2>üî• NEUE VERSION L√ÑUFT üî•</h2>

<!-- PIN -->
<div id="pin-screen">
  <h2>PIN eingeben</h2>
  <input type="password" id="pin-input" placeholder="6-stellige PIN">
  <button class="button-green" onclick="checkPin()">Best√§tigen</button>
  <p id="pin-error" style="color:red;"></p>
</div>

<div id="status"></div>

<div id="qr-reader"></div>

<div id="gast">
  <h3 id="name">Gast</h3>
  <p><b>Guthaben:</b> <span id="guthaben">0.00</span> ‚Ç¨</p>

  <button class="button-green" onclick="aufladen()">‚û°Ô∏è Aufladen</button>
  <button class="button-red" onclick="auszahlen()">‚¨ÖÔ∏è Auszahlen</button>

  <div id="produkte"></div>

  <div id="warenkorb-container">
    <h4>Ausgew√§hlte Produkte</h4>
    <ul id="warenkorb"></ul>
  </div>

  <p><b>Zwischensumme:</b> <span id="summe">0.00</span> ‚Ç¨</p>
  <button class="button-orange" onclick="buchen()">Buchen ‚úÖ</button>

  <textarea id="notiz" placeholder="Notizen (max. 500 Zeichen)" maxlength="500"></textarea>
  <div id="notiz-counter">500 Zeichen √ºbrig</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== PIN ===== */
const APP_PIN = "739284";

function checkPin() {
  const entered = document.getElementById("pin-input").value;
  if (entered === APP_PIN) {
    document.getElementById("pin-screen").style.display = "none";
    document.getElementById("qr-reader").style.display = "block";
    startScan();
  } else {
    document.getElementById("pin-error").textContent = "Falscher PIN!";
  }
}

/* ===== STATE ===== */
let currentId = "";
let gaeste = {}; // id ‚Üí {guthaben, warenkorb, notiz}
let scanner = null;

/* ===== PRODUKTE ===== */
const produkte = [
  {name:"Bier", preise:[1,1.5,2,2.5,3,3.5]},
  {name:"Wasser", preise:[1,2,3]},
  {name:"Cocktail", preise:[4.5,5.5,6.5,7.5]},
  {name:"Shots", preise:[1,1.5,2,2.5]}
];

/* ===== STATUS ===== */
function updateStatus(){
  document.getElementById("status").textContent =
    navigator.onLine ? "üü¢ Online" : "üî¥ Offline ‚Äì Buchungen werden gemerkt";
}
updateStatus();
window.addEventListener("online", updateStatus);
window.addEventListener("offline", updateStatus);

/* ===== QR SCAN ===== */
function startScan(){
  if (scanner) return;
  scanner = new Html5Qrcode("qr-reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    text => {
      scanner.stop().then(() => scanner.clear());
      currentId = text.trim();
      if (!gaeste[currentId]) {
        gaeste[currentId] = {guthaben: 20, warenkorb: [], notiz: ""};
      }
      showGast();
    }
  );
}

function showGast(){
  const gast = gaeste[currentId];
  document.getElementById("gast").style.display = "block";
  document.getElementById("warenkorb-container").style.display = "block";
  document.getElementById("name").textContent = currentId;
  document.getElementById("guthaben").textContent = gast.guthaben.toFixed(2);
  document.getElementById("notiz").value = gast.notiz;
  updateWarenkorb();
  renderProdukte();
}

/* ===== PRODUKTBUTTONS ===== */
function renderProdukte(){
  const div = document.getElementById("produkte");
  div.innerHTML = "";
  produkte.forEach(p => {
    const box = document.createElement("div");
    box.className = "scrollbox";
    box.innerHTML = `<b>${p.name}</b>`;
    p.preise.forEach(preis => {
      const b = document.createElement("button");
      b.className = "button-orange";
      b.textContent = `${preis.toFixed(2)} ‚Ç¨`;
      b.onclick = () => {
        gaeste[currentId].warenkorb.push({name: p.name, preis, menge:1});
        updateWarenkorb();
      };
      box.appendChild(b);
    });
    div.appendChild(box);
  });
  div.style.display = "block";
}

/* ===== WARENKORB ===== */
function updateWarenkorb(){
  const ul = document.getElementById("warenkorb");
  ul.innerHTML = "";
  let summe = 0;
  const gast = gaeste[currentId];
  gast.warenkorb.forEach((item, index) => {
    summe += item.preis * item.menge;
    const li = document.createElement("li");
    li.innerHTML = `${item.name} ‚Äì ${item.preis.toFixed(2)} ‚Ç¨ x${item.menge} 
      <button onclick="loeschen(${index})">‚ùå</button>
      <button onclick="aendernMenge(${index}, item.menge+1)">+1</button>
      <button onclick="aendernMenge(${index}, 2)">x2</button>
      <button onclick="aendernMenge(${index}, 3)">x3</button>`;
    ul.appendChild(li);
  });
  document.getElementById("summe").textContent = summe.toFixed(2);
}

function loeschen(index){
  gaeste[currentId].warenkorb.splice(index,1);
  updateWarenkorb();
}

function aendernMenge(index, menge){
  gaeste[currentId].warenkorb[index].menge = menge;
  updateWarenkorb();
}

/* ===== AKTIONEN ===== */
function aufladen(){
  const v = parseFloat(prompt("Aufladen (‚Ç¨):", "10"));
  if (v) {
    gaeste[currentId].guthaben += v;
    document.getElementById("guthaben").textContent = gaeste[currentId].guthaben.toFixed(2);
  }
}

function auszahlen(){
  if (confirm("Guthaben auszahlen und auf 0 setzen?")) {
    gaeste[currentId].guthaben = 0;
    document.getElementById("guthaben").textContent = "0.00";
  }
}

function buchen(){
  const gast = gaeste[currentId];
  let summe = gast.warenkorb.reduce((acc,i)=>acc+i.preis*i.menge,0);
  if (summe > gast.guthaben) {
    alert("Nicht genug Guthaben!");
    return;
  }
  gast.guthaben -= summe;
  gast.warenkorb = [];
  gast.notiz = "";
  document.getElementById("guthaben").textContent = gast.guthaben.toFixed(2);
  resetScanner();
  alert("Gebucht!");
}

/* ===== RESET & NEU SCANNEN ===== */
function resetScanner(){
  document.getElementById("gast").style.display = "none";
  currentId = "";
  document.getElementById("summe").textContent = "0.00";
  document.getElementById("notiz").value = "";
  document.getElementById("notiz-counter").textContent = "500 Zeichen √ºbrig";
  updateWarenkorb();
  startScan();
}

/* ===== NOTIZ ===== */
const notiz = document.getElementById("notiz");
const counter = document.getElementById("notiz-counter");
notiz.addEventListener("input",()=>{
  const len = notiz.value.length;
  counter.textContent = (500-len) + " Zeichen √ºbrig";
  if (len <= 200){
    notiz.style.fontSize="16px";
  } else {
    let size = 16-(len-200)/20;
    if (size<8) size=8;
    notiz.style.fontSize=size+"px";
  }
  if(currentId) gaeste[currentId].notiz = notiz.value;
});
</script>
</body>
</html>
