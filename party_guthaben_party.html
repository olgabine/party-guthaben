<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Party Guthaben</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial,sans-serif; margin:10px; background: linear-gradient(135deg,#0b3d91,#0f4ea1); color:#fff; }
h2,h3{ text-shadow:1px 1px 2px #000; }
button{ padding:14px 20px; margin:6px 0; font-size:18px; border:none; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; color:#000; }
.button-green{ background: linear-gradient(to right,#2ecc71,#27ae60); }
.button-red{ background: linear-gradient(to right,#e74c3c,#c0392b); }
.button-orange{ background: linear-gradient(to right,#f39c12,#e67e22); }
#qr-reader{ width:100%; margin-top:15px; }
#status{ margin-top:10px; font-weight:bold; }
#gast{ display:none; margin-top:20px; }
textarea{ width:100%; height:70px; font-size:16px; resize:none; margin-top:10px; }
#notiz-counter{ font-size:14px; margin-top:4px; }
#produkte{ margin-top:10px; }
.warenkorb-item{ display:flex; justify-content:space-between; align-items:center; margin:4px 0; background:rgba(255,255,255,0.1); padding:6px 8px; border-radius:6px; }
.warenkorb-item button{ width:36px; padding:4px; margin-left:4px; font-size:16px; }
</style>
</head>
<body>

<h2>üî• Party Guthaben üî•</h2>

<button class="button-green" onclick="startScan()">üì∑ QR-Code scannen</button>
<div id="qr-reader"></div>
<div id="status"></div>

<div id="gast">
  <h3 id="name">Gast</h3>
  <p><b>Guthaben:</b> <span id="guthaben">0.00</span> ‚Ç¨</p>

  <button class="button-green" onclick="aufladen()">‚û°Ô∏è Aufladen</button>
  <button class="button-red" onclick="auszahlen()">‚¨ÖÔ∏è Auszahlen</button>

  <button class="button-orange" onclick="neuesProdukt()">‚ûï Neues Produkt hinzuf√ºgen</button>

  <div id="produkte"></div>

  <h4>Warenkorb</h4>
  <div id="warenkorb"></div>

  <p><b>Zwischensumme:</b> <span id="summe">0.00</span> ‚Ç¨</p>
  <button class="button-orange" onclick="buchen()">Buchen ‚úÖ</button>

  <textarea id="notiz" placeholder="Notizen (max. 500 Zeichen)"></textarea>
  <div id="notiz-counter">500 Zeichen √ºbrig</div>

  <button class="button-green" onclick="scanAgain()">QR-Code erneut scannen üîÑ</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let currentId=""; let gaeste={}; let summe=0; let scanner=null;

// STATUS
function updateStatus(){
  document.getElementById("status").textContent =
    navigator.onLine ? "üü¢ Online" : "üî¥ Offline ‚Äì Buchungen werden gepuffert";
}
updateStatus();
window.addEventListener("online",updateStatus);
window.addEventListener("offline",updateStatus);

// QR-SCAN
function startScan(){if(scanner) return; scanner=new Html5Qrcode("qr-reader"); scanner.start({facingMode:"environment"},{fps:10,qrbox:250},text=>{scanner.stop().then(()=>scanner.clear()); currentId=text.trim(); checkGast(currentId);});}
function scanAgain(){summe=0; document.getElementById("summe").textContent="0.00"; document.getElementById("warenkorb").innerHTML=""; document.getElementById("notiz").value=""; document.getElementById("notiz-counter").textContent="500 Zeichen √ºbrig"; startScan();}

// GAST
function checkGast(id){ google.script.run.withSuccessHandler(initGast).ensureGast(id); }
function initGast(data){
  if(!data.name){ let name=prompt("Name des Gastes:"); google.script.run.withSuccessHandler(initGast).ensureGast(currentId,name); return;}
  gaeste[currentId]={guthaben:data.guthaben,warenkorb:[],notiz:""};
  document.getElementById("name").textContent=data.name;
  document.getElementById("guthaben").textContent=data.guthaben.toFixed(2);
  document.getElementById("gast").style.display="block";
  loadProdukte();
}

// PRODUKTE
function loadProdukte(){ google.script.run.withSuccessHandler(renderProdukte).getProdukte(); }
function renderProdukte(produkte){
  const div=document.getElementById("produkte"); div.innerHTML="<h4>Produkte</h4>";
  produkte.forEach(p=>{
    const container=document.createElement("div");
    const name=document.createElement("b"); name.textContent=p.name; container.appendChild(name); container.appendChild(document.createElement("br"));
    p.preise.forEach(preis=>{
      const b=document.createElement("button"); b.className="button-orange"; b.textContent=preis.toFixed(2)+" ‚Ç¨";
      b.onclick=()=>{ addWarenkorb(p.name,preis); }; container.appendChild(b);
    });
    div.appendChild(container);
  });
}

// WARENKORB
function addWarenkorb(name,preis){ summe+=preis; document.getElementById("summe").textContent=summe.toFixed(2); gaeste[currentId].warenkorb.push({name:name,preis:preis,menge:1,notiz:document.getElementById("notiz").value}); renderWarenkorb(); }
function renderWarenkorb(){
  const div=document.getElementById("warenkorb"); div.innerHTML="";
  gaeste[currentId].warenkorb.forEach((item,i)=>{
    const row=document.createElement("div"); row.className="warenkorb-item";
    row.innerHTML=`${item.name} ‚Äì ${item.preis.toFixed(2)} ‚Ç¨ x ${item.menge}`;
    const plus=document.createElement("button"); plus.textContent="+"; plus.onclick=()=>{ item.menge++; summe+=item.preis; document.getElementById("summe").textContent=summe.toFixed(2); renderWarenkorb();};
    const minus=document.createElement("button"); minus.textContent="-"; minus.onclick=()=>{ item.menge--; summe-=item.preis; if(item.menge<=0){ gaeste[currentId].warenkorb.splice(i,1);} document.getElementById("summe").textContent=summe.toFixed(2); renderWarenkorb();};
    row.appendChild(plus); row.appendChild(minus); div.appendChild(row);
  });
}

// AUFLADEN / AUSZAHLEN
function aufladen(){ const v=parseFloat(prompt("Aufladen (‚Ç¨):","5")); if(v){ google.script.run.withSuccessHandler(g=>{ gaeste[currentId].guthaben=g; document.getElementById("guthaben").textContent=g.toFixed(2);}).aufladenGast(currentId,v); } }
function auszahlen(){ if(confirm("Guthaben auszahlen?")){ gaeste[currentId].warenkorb=[]; summe=0; document.getElementById("summe").textContent="0.00"; document.getElementById("warenkorb").innerHTML=""; document.getElementById("guthaben").textContent="0.00"; }}

// BUCHEN
function buchen(){ if(summe>gaeste[currentId].guthaben){ alert("Nicht genug Guthaben!"); return; } google.script.run.saveBooking(currentId,gaeste[currentId].warenkorb); gaeste[currentId].guthaben-=summe; summe=0; gaeste[currentId].warenkorb=[]; document.getElementById("summe").textContent="0.00"; document.getElementById("warenkorb").innerHTML=""; document.getElementById("guthaben").textContent=gaeste[currentId].guthaben.toFixed(2); document.getElementById("notiz").value=""; document.getElementById("notiz-counter").textContent="500 Zeichen √ºbrig"; alert("Gebucht!"); scanAgain();}

// NOTIZ
const notiz=document.getElementById("notiz"); const counter=document.getElementById("notiz-counter");
notiz.addEventListener("input",()=>{ const len=notiz.value.length; counter.textContent=(500-len)+" Zeichen √ºbrig"; notiz.style.fontSize=len<=200 ? "16px" : Math.max(8,16-(len-200)/20)+"px"; });

// NEUES PRODUKT HINZUF√úGEN
function neuesProdukt(){
  const name=prompt("Name des Produkts:"); if(!name) return;
  const preiseStr=prompt("Preise durch Komma getrennt, z.B. 1,1.5,2:"); if(!preiseStr) return;
  const preise=preiseStr.split(",").map(p=>parseFloat(p.trim())).filter(p=>!isNaN(p));
  if(preise.length==0){ alert("Keine g√ºltigen Preise!"); return;}
  google.script.run.withSuccessHandler(()=>loadProdukte()).addProdukt(name,preise);
  alert("Produkt hinzugef√ºgt: "+name);
}
</script>
</body>
</html>
